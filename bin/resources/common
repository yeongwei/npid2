#!/bin/bash

## ==================================================
## 1. Common functions used by the script
## ==================================================

log() {
  severity=$1
  shift
  timestamp=`date "+%Y-%m-%d %H:%M:%S.%N"|cut -b1-23`
  echo "[${severity}] [${timestamp}] [npid] $@" | tee -a ${CONSOLE_LOG}
}

showVersion() {
  log INFO "GYMPB0102I: Application: ${PROG_NAME2} Version: ${PROG_VERSION}"
  exit 0
}

##
## E.g.
## npid start zookeeper
## npid start kafka
## npid start hadoop
## npid start npi
##	
npidUsage() {
	echo ""
	echo "Usage: npid {start|stop|restart|kill|status|version|help} {all|<component_name>|<service_name>}"
	echo "component_name: {npi}"
	echo "service_name: {zookeeper|kafka|hadoop}"
	echo ""
	echo "Example: "
	echo "	1) npid start all"
	echo "	2) npid start npi"
	echo "	3) npid start zookeeper"
	echo "	4) npid stop all"
	echo ""
}

##
## If 1 then log ERROR then exit with -1
## Example: emergencyExit $status "GYM ..."
##
emergencyExit() {
	if [ ${1} -eq 1 ]; then
		log ERROR ${2}; exit -1
	fi
}

##
## Check based on application name if, 
##	1. appplication PID file exist 
##	2. PID file is not empty
##	3. PID is found under ps ax
## Return 1 if found else 0
## E.g. 
##	isPidValid zookeeper
##	isPidValid storage
##
isPidValid() {
	pidFile=${VAR_DIR}/${1}.pid

	if [ -f ${pidFile} ]; then 
		pid=`head -1 ${pidFile}`
		if [ -z "${pid}" ]; then # pid file is empty
			echo -2
		else # pid file not empty
			if [ -z "`ps ax | grep ${pid} | grep -v grep`" ]; then # pid is not within ps
				echo -3
			else # pid is valid within ps
				echo 1
			fi
		fi	
	else # no pid file exists
		echo -1
	fi
}

##
## Retrieve information from ps with grep name
## Expected to pass in the Application Name. E.g. zookeeper, hadoop
##
getPsByName() {
	echo "`ps ax | grep ${1} | grep -v grep | grep -v ${PROG_NAME}`"
}

##
## Created PID file based on application name. E.g. kafka.pid
##
writePID() {
	if [ $# -eq 2 ]; then
		echo $2 > ${VAR_DIR}/${1}.pid
	else
		log ERROR "GYMPB0000E: Not enough arguments to write into PID file."
		exit 1
	fi
}

##
## Remove PID file based on application name. E.g. hadoop.pid
##
removePID() {
	rm ${VAR_DIR}/${1}.pid
}

##
## Get pid from PID file. E.g. hadoop.pid
##
getPID() {
	if [ -f ${VAR_DIR}/${1}.pid ]; then
		echo -e `head -1 ${VAR_DIR}/${1}.pid` # cat or head ???
	else
		echo ""
	fi
}

##
## Kill(15) pid and it's associated processes
## Usage: killAssociatively -9 1145
##
killAssociatively() {
	ps -ef | grep ${2} | grep -v grep | awk '{print $2}' | xargs -i kill ${1} {}
}

##
## Check application status based on application name,
## since each application has dedicated PID file
## Example,
## 	1. checkStatus zookeeper
##	2. checkStatus npi
##
checkStatus() {
	if [ -f ${VAR_DIR}/${1}.pid ]; then
		pid=`getPID ${1}`
		pidStatus=`isPidValid ${1}`
		if [ ${pidStatus} == "1" ]; then
			log INFO "GYMPB0116I: Application `getReadableName ${1}` is running on pid ${pid}."
		else
			log INFO "GYMPB0117I: Application `getReadableName ${1}` is not started."
		fi		
	else
		log INFO "GYMPB0117I: Application `getReadableName ${1}` is not started."
	fi		
}

##
## Check application status based on the PID files found in var/*
## 1. Zookeeper: Via ZOOKEEPER_URL
## 2. Kafka: Via ZOOKEEPER_URL
## 3. Hadoop: Via Hadoop Resource Manager Web Service
## 4. NPI: Via PID (Local instance only)
##
checkAllStatus() {
	allAvailPidFile=`ls -1 ${VAR_DIR}`
	allAvailPidFile2=(${allAvailPidFile[*]}) # Transpose into array

	if [ ${#allAvailPidFile2[@]} -eq 0 ]; then
		log INFO "GYMPB0117I: No application started."
	else
		for pidFile in "${allAvailPidFile2[@]}"; do
			appName=`echo ${pidFile} | cut -d. -f1`
			appPid=`head -1 ${VAR_DIR}/${pidFile}` # should use cat or head ???

			pidStatus=`isPidValid ${appName}`
			if [ ${pidStatus} -eq 1 ]; then
				log INFO "GYMPB0116I: Application `getReadableName ${appName}` is running on pid ${appPid}."
			else
				log INFO "GYMPB0116I: Application `getReadableName ${appName}` is not running."
			fi
		done
	fi 
}

##
## Application names are usually all lowercase
## Example: Hadoop -> hadoop
##
getApplicationName() {
	case "${1}" in
		"${ZOOKEEPER_READABLE}")
			echo ${ZOOKEEPER_APP_NAME}		
		;;
		"${KAFKA_READABLE} ")
			echo ${KAFKA_APP_NAME}	
		;;
		"${HADOOP_READABLE}")
			echo ${HADOOP_APP_NAME}	
		;;
		"${NPI_READABLE}")
			echo ${NPI_APP_NAME}
		;;
		"${NPI_STORAGE_READABLE}")
			echo ${NPI_STORAGE_APP_NAME}	
		;;
		"${NPI_ANALYTICS_READABLE}")
			echo ${NPI_ANALYTICS_APP_NAME}
		;;
		"${NPI_COLLECTOR_READABLE}")
			echo ${NPI_COLLECTOR_APP_NAME}		
		;;
		"${NPI_UI_READABLE}")
			echo ${NPI_UI_APP_NAME}
		;;
		*)
			echo "NA"
		;;
	esac
}

##
## Readable names are usually with first letter as capital
##
getReadableName() {
	case "${1}" in
		"${ZOOKEEPER_APP_NAME}")
			echo ${ZOOKEEPER_READABLE}		
		;;
		"${KAFKA_APP_NAME}")
			echo ${KAFKA_READABLE} 		
		;;
		"${HADOOP_APP_NAME}")
			echo ${HADOOP_READABLE}		
		;;
		"${NPI_APP_NAME}")
			echo ${NPI_READABLE}
		;;
		"${NPI_STORAGE_APP_NAME}")
			echo ${NPI_STORAGE_READABLE}		
		;;
		"${NPI_ANALYTICS_APP_NAME}")
			echo ${NPI_ANALYTICS_READABLE}
		;;
		"${NPI_COLLECTOR_APP_NAME}")
			echo ${NPI_COLLECTOR_READABLE}		
		;;
		"${NPI_UI_APP_NAME}")
			echo ${NPI_UI_READABLE}
		;;
		*)
			echo "NA"
		;;
	esac
}

##
## Get PID files related to NPI only
## Example storage.pid, analytics.pid, collector.pid, ui.pid, npi.pid
## Return as string delimited by space
## Best practice to return into variable quoted by ()
##
getNpiPidFiles() {
	grepPidFilesStr="(${NPI_UI_APP_NAME}|${NPI_COLLECTOR_APP_NAME}|${NPI_ANALYTICS_APP_NAME}|${NPI_STORAGE_APP_NAME}|${NPI_APP_NAME})"
	npiPidFiles=`ls ${VAR_DIR} | egrep ${grepPidFilesStr}`
	echo ${npiPidFiles[*]}
}

